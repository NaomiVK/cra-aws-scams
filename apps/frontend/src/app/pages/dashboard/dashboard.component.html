<div class="container-fluid py-4">
  <!-- Header -->
  <div class="row mb-4">
    <div class="col">
      <h1 class="h3 mb-0">CRA Misinformation and Scams</h1>
      <p class="text-muted">Monitor potential scam-related searches targeting CRA pages</p>
    </div>
    <div class="col-auto d-flex align-items-center gap-3">
      <span class="badge bg-primary fs-6" ngbTooltip="Currently viewing data for this period">
        <i class="bi bi-calendar3 me-1"></i>
        {{ dateRange().startDate }} to {{ dateRange().endDate }}
      </span>
      <div class="btn-group" role="group" aria-label="Select time period for analysis" ngbTooltip="Select time period for analysis">
        <button class="btn" [class]="selectedDays() === 7 ? 'btn-primary' : 'btn-outline-secondary'" (click)="onQuickDateRange(7)" [attr.aria-pressed]="selectedDays() === 7">7 Days</button>
        <button class="btn" [class]="selectedDays() === 14 ? 'btn-primary' : 'btn-outline-secondary'" (click)="onQuickDateRange(14)" [attr.aria-pressed]="selectedDays() === 14">14 Days</button>
        <button class="btn" [class]="selectedDays() === 28 ? 'btn-primary' : 'btn-outline-secondary'" (click)="onQuickDateRange(28)" [attr.aria-pressed]="selectedDays() === 28">28 Days</button>
        <button class="btn" [class]="selectedDays() === 90 ? 'btn-primary' : 'btn-outline-secondary'" (click)="onQuickDateRange(90)" [attr.aria-pressed]="selectedDays() === 90">90 Days</button>
      </div>
      <button class="btn btn-outline-secondary" (click)="loadDashboard(); loadEmergingThreats()" ngbTooltip="Refresh dashboard data" aria-label="Refresh dashboard data">
        <i class="bi bi-arrow-clockwise" aria-hidden="true"></i>
      </button>
    </div>
  </div>

  <!-- Loading State -->
  @if (loading()) {
    <div class="text-center py-5" aria-live="polite" aria-busy="true">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-2 text-muted">Loading dashboard data...</p>
    </div>
  }

  <!-- Error State -->
  @if (error()) {
    <div class="alert alert-danger" role="alert">
      <strong>Error:</strong> {{ error() }}
      <button class="btn btn-link" (click)="loadDashboard()">Retry</button>
    </div>
  }

  <!-- Dashboard Content -->
  @if (!loading() && !error() && dashboardData()) {
    <!-- Main Content: Critical Alerts (left) + KPI Cards (right) -->
    <div class="row mb-4">
      <!-- Critical Alerts Panel -->
      <div class="col-lg-8">
        <div class="card h-100">
          <div class="card-header bg-danger text-white d-flex justify-content-between align-items-center" ngbTooltip="Queries matching critical severity patterns - highest priority for investigation">
            <h5 class="mb-0">
              <i class="bi bi-exclamation-octagon me-2"></i>
              Critical Alerts
            </h5>
            <span class="badge bg-light text-danger fs-6">{{ dashboardData()!.criticalAlerts.length }}</span>
          </div>
          <div class="card-body alert-panel p-0">
            @for (term of dashboardData()!.criticalAlerts; track term.query) {
              <div class="alert-item">
                <div class="d-flex justify-content-between align-items-start">
                  <div class="flex-grow-1">
                    <div class="d-flex align-items-center gap-2">
                      <strong>{{ term.query }}</strong>
                      @if (term.isNew) {
                        <span class="badge bg-info text-white small-badge" ngbTooltip="First time appearing in this period">NEW</span>
                      }
                    </div>
                    <div class="small text-muted" ngbTooltip="Matched scam patterns">
                      {{ term.matchedPatterns.join(', ') }}
                    </div>
                  </div>
                  <table class="metrics-table">
                    <thead>
                      <tr>
                        <th></th>
                        <th>Current</th>
                        <th>Previous</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td class="metric-label">Impressions</td>
                        <td class="metric-value">{{ term.impressions | number }}</td>
                        <td class="metric-value text-muted">{{ term.previous ? (term.previous.impressions | number) : '-' }}</td>
                      </tr>
                      <tr>
                        <td class="metric-label">Position</td>
                        <td class="metric-value">{{ term.position | number:'1.1-1' }}</td>
                        <td class="metric-value text-muted">{{ term.previous ? (term.previous.position | number:'1.1-1') : '-' }}</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            } @empty {
              <div class="p-4 text-center text-muted">
                <i class="bi bi-check-circle fs-1 text-success"></i>
                <p class="mt-2 mb-0">No critical alerts detected</p>
                <small>All monitored queries appear normal</small>
              </div>
            }
          </div>
        </div>
      </div>

      <!-- KPI Cards (right side, stacked 2x2) -->
      <div class="col-lg-4">
        <div class="row g-3">
          <div class="col-6">
            <div class="card kpi-card border-danger h-100" ngbTooltip="Queries matching critical scam patterns">
              <div class="card-body text-center py-3">
                <i class="bi bi-exclamation-octagon-fill text-danger fs-2"></i>
                <div class="kpi-value text-danger mt-2">{{ dashboardData()!.summary.critical }}</div>
                <div class="kpi-label">Critical</div>
              </div>
            </div>
          </div>
          <div class="col-6">
            <div class="card kpi-card border-warning h-100" ngbTooltip="Queries with threat language or urgency tactics">
              <div class="card-body text-center py-3">
                <i class="bi bi-exclamation-triangle-fill text-warning fs-2"></i>
                <div class="kpi-value text-warning mt-2">{{ dashboardData()!.summary.high }}</div>
                <div class="kpi-label">High Priority</div>
              </div>
            </div>
          </div>
          <div class="col-12">
            <div class="card kpi-card h-100" ngbTooltip="Total unique search queries analyzed from Google Search Console">
              <div class="card-body text-center py-3">
                <i class="bi bi-search text-primary fs-2"></i>
                <div class="kpi-value mt-2">{{ dashboardData()!.totalQueriesAnalyzed | number }}</div>
                <div class="kpi-label">Queries Analyzed</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- High Priority Alerts Panel -->
    @if (dashboardData()!.highAlerts && dashboardData()!.highAlerts.length > 0) {
      <div class="row mb-4">
        <div class="col-12">
          <div class="card">
            <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center" ngbTooltip="Queries matching high severity patterns - review promptly">
              <h5 class="mb-0">
                <i class="bi bi-exclamation-triangle me-2"></i>
                High Priority Alerts
              </h5>
              <span class="badge bg-dark text-warning fs-6">{{ dashboardData()!.highAlerts.length }}</span>
            </div>
            <div class="card-body alert-panel p-0">
              @for (term of dashboardData()!.highAlerts; track term.query) {
                <div class="alert-item">
                  <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                      <div class="d-flex align-items-center gap-2">
                        <strong>{{ term.query }}</strong>
                        @if (term.isNew) {
                          <span class="badge bg-info text-white small-badge" ngbTooltip="First time appearing in this period">NEW</span>
                        }
                      </div>
                      <div class="small text-muted" ngbTooltip="Matched scam patterns">
                        {{ term.matchedPatterns.join(', ') }}
                      </div>
                    </div>
                    <table class="metrics-table">
                      <thead>
                        <tr>
                          <th></th>
                          <th>Current</th>
                          <th>Previous</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr>
                          <td class="metric-label">Impressions</td>
                          <td class="metric-value">{{ term.impressions | number }}</td>
                          <td class="metric-value text-muted">{{ term.previous ? (term.previous.impressions | number) : '-' }}</td>
                        </tr>
                        <tr>
                          <td class="metric-label">Position</td>
                          <td class="metric-value">{{ term.position | number:'1.1-1' }}</td>
                          <td class="metric-value text-muted">{{ term.previous ? (term.previous.position | number:'1.1-1') : '-' }}</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              }
            </div>
          </div>
        </div>
      </div>
    }

    <!-- Top 10 New Terms Card -->
    @if (dashboardData()!.newTerms && dashboardData()!.newTerms.length > 0) {
      <div class="row mb-4">
        <div class="col-12">
          <div class="card">
            <div class="card-header bg-info text-white d-flex justify-content-between align-items-center" ngbTooltip="Search terms that appeared this period but not in the previous period">
              <h5 class="mb-0">
                <i class="bi bi-graph-up-arrow me-2"></i>
                Top 10 New Terms This Period
              </h5>
              <a routerLink="/comparison" class="btn btn-sm btn-light" ngbTooltip="View full comparison analysis">
                View All <i class="bi bi-arrow-right"></i>
              </a>
            </div>
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-hover mb-0">
                  <thead class="table-light">
                    <tr>
                      <th>Search Term</th>
                      <th class="text-end">Impressions</th>
                    </tr>
                  </thead>
                  <tbody>
                    @for (term of dashboardData()!.newTerms; track term.query) {
                      <tr>
                        <td>{{ term.query }}</td>
                        <td class="text-end">{{ term.current.impressions | number }}</td>
                      </tr>
                    }
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    }

    <!-- Emerging Scams Summary Card -->
    @if (loadingEmergingThreats()) {
      <div class="card border-warning" aria-live="polite" aria-busy="true">
        <div class="card-body text-center py-4">
          <div class="spinner-border spinner-border-sm text-warning me-2" role="status">
            <span class="visually-hidden">Loading emerging threats...</span>
          </div>
          <span class="text-muted">Loading emerging threats...</span>
        </div>
      </div>
    } @else if (emergingThreatsError()) {
      <div class="card border-danger">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h5 class="card-title mb-1 text-danger">
                <i class="bi bi-exclamation-circle me-2"></i>
                Failed to Load Emerging Scams
              </h5>
              <p class="text-muted mb-0 small">{{ emergingThreatsError() }}</p>
            </div>
            <button class="btn btn-outline-danger" (click)="loadEmergingThreats()">
              <i class="bi bi-arrow-clockwise me-1"></i> Retry
            </button>
          </div>
        </div>
      </div>
    } @else if (emergingThreats(); as threats) {
      <div class="card border-warning">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h5 class="card-title mb-1">
                <i class="bi bi-shield-exclamation text-warning me-2" aria-hidden="true"></i>
                Emerging Scams
              </h5>
              <p class="text-muted mb-0 small" ngbTooltip="Detected via AI semantic matching, CTR anomalies, velocity patterns, and regex pattern matching">
                Potential scam terms identified through multi-signal analysis
              </p>
            </div>
            <div class="d-flex align-items-center gap-3">
              <div class="text-center" ngbTooltip="Risk score 76-100: Immediate action required">
                <span class="badge bg-danger fs-6">{{ threats.summary.critical }}</span>
                <div class="small text-muted">Critical</div>
              </div>
              <div class="text-center" ngbTooltip="Risk score 51-75: Review promptly">
                <span class="badge bg-warning text-dark fs-6">{{ threats.summary.high }}</span>
                <div class="small text-muted">High</div>
              </div>
              <div class="text-center" ngbTooltip="Total emerging threats detected">
                <span class="badge bg-secondary fs-6">{{ threats.summary.total }}</span>
                <div class="small text-muted">Total</div>
              </div>
              <a routerLink="/admin" class="btn btn-outline-warning" ngbTooltip="Review and manage emerging threats in the Admin Console">
                Review in Admin Console <i class="bi bi-arrow-right" aria-hidden="true"></i>
              </a>
            </div>
          </div>
        </div>
      </div>
    }
  }
</div>

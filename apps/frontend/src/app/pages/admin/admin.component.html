<div class="container-fluid py-4">
  <div class="row mb-4">
    <div class="col">
      <h1 class="h3 mb-0">Admin Console</h1>
      <p class="text-muted">Manage scam detection keywords and monitor emerging threats</p>
    </div>
    @if (isAuthenticated()) {
      <div class="col-auto d-flex gap-2 align-items-center">
        <span class="badge bg-success">
          <i class="bi bi-check-circle me-1"></i>
          Authenticated
        </span>
        <button class="btn btn-outline-secondary btn-sm" (click)="logout()">
          <i class="bi bi-box-arrow-right me-1"></i>
          Logout
        </button>
        <button class="btn btn-success" (click)="exportConfig()" [disabled]="!keywordsConfig()"
                ngbTooltip="Download the current keyword configuration as JSON">
          <i class="bi bi-download me-1"></i>
          Export Configuration
        </button>
      </div>
    }
  </div>

  <!-- Auth Gate - Wrap entire admin console -->
  @if (!isAuthenticated()) {
    <div class="card">
      <div class="card-body">
        <h5 class="card-title">
          <i class="bi bi-lock me-2"></i>
          Admin Authentication Required
        </h5>
        <p class="text-muted">Enter the admin password to access the Admin Console.</p>

        @if (!authConfigured()) {
          <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle me-2"></i>
            Admin authentication is not configured. Set ADMIN_PASSWORD_HASH in your environment.
          </div>
        } @else {
          <div class="row">
            <div class="col-md-6">
              <div class="input-group">
                <input type="password" class="form-control" placeholder="Enter admin password"
                       [ngModel]="loginPassword()" (ngModelChange)="loginPassword.set($event)"
                       (keyup.enter)="submitLogin()">
                <button class="btn btn-primary" (click)="submitLogin()" [disabled]="loginLoading()">
                  @if (loginLoading()) {
                    <span class="spinner-border spinner-border-sm me-1"></span>
                  }
                  Login
                </button>
              </div>
              @if (loginError()) {
                <small class="text-danger">{{ loginError() }}</small>
              }
            </div>
          </div>
        }
      </div>
    </div>
  } @else {
    <!-- Authenticated - Show tabs -->
    <ul ngbNav #nav="ngbNav" [(activeId)]="activeTab" class="nav-tabs" (navChange)="onTabChange($event.nextId)">
      <li [ngbNavItem]="1">
        <button ngbNavLink>Emerging Threats</button>
        <ng-template ngbNavContent>
          <div class="pt-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <div>
                @if (emergingThreats(); as data) {
                  <span class="badge bg-danger me-2" ngbTooltip="Risk score 76-100: Immediate action required">{{ data.summary.critical }} Critical</span>
                  <span class="badge bg-warning text-dark me-2" ngbTooltip="Risk score 51-75: Review promptly">{{ data.summary.high }} High</span>
                  <span class="badge bg-info text-dark me-2" ngbTooltip="Risk score 31-50: Monitor closely">{{ data.summary.medium }} Medium</span>
                  <span class="badge bg-secondary" ngbTooltip="Risk score 0-30: Low priority">{{ data.summary.low }} Low</span>
                }
              </div>
              <div>
                <select class="form-select form-select-sm" [ngModel]="selectedDays()" (ngModelChange)="selectedDays.set($event); onDaysChange()"
                        ngbTooltip="Compare current period vs previous period">
                  <option [value]="7">Last 7 days</option>
                  <option [value]="14">Last 14 days</option>
                  <option [value]="28">Last 28 days</option>
                  <option [value]="90">Last 90 days</option>
                </select>
              </div>
            </div>

            @if (loading()) {
              <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
              </div>
            } @else if (error()) {
              <div class="alert alert-danger">{{ error() }}</div>
            } @else if (emergingThreats(); as data) {
              @if (data.threats.length === 0) {
                <div class="alert alert-success">No emerging threats detected.</div>
              } @else {
                <!-- Bulk Actions Bar -->
                @if (getSelectedCount() > 0) {
                  <div class="alert alert-info d-flex justify-content-between align-items-center mb-3">
                    <span>
                      <strong>{{ getSelectedCount() }}</strong> item(s) selected
                    </span>
                    <div class="btn-group">
                      <button class="btn btn-danger btn-sm" (click)="bulkAddToKeywords()"
                              ngbTooltip="Add selected items to scam keywords">
                        <i class="bi bi-plus-circle me-1"></i> Add to Keywords
                      </button>
                      <button class="btn btn-secondary btn-sm" (click)="bulkDismiss()"
                              ngbTooltip="Dismiss selected items">
                        <i class="bi bi-x-circle me-1"></i> Dismiss
                      </button>
                    </div>
                  </div>
                }

                <div class="table-responsive">
                  <table class="table table-hover">
                    <thead class="table-light">
                      <tr>
                        <th style="width: 40px;">
                          <input type="checkbox" class="form-check-input"
                                 [checked]="isAllSelected()"
                                 (change)="toggleSelectAll()"
                                 ngbTooltip="Select all on this page">
                        </th>
                        <th ngbTooltip="Search query from Google Search Console">Query</th>
                        <th ngbTooltip="Composite risk score (0-100) based on CTR anomaly, position, volume, velocity, and pattern matches">Risk</th>
                        <th ngbTooltip="Click-through rate compared to expected CTR for this position. Low CTR at good position = users clicking scam sites instead">CTR Anomaly</th>
                        <th ngbTooltip="Average ranking position in search results">Pos</th>
                        <th ngbTooltip="Number of times users saw CRA pages for this query">Impr</th>
                        <th ngbTooltip="Number of clicks from this query to CRA pages">Clicks</th>
                        <th ngbTooltip="Velocity = (Current Impressions - Previous Impressions) / Days. Shows impressions growth per day. Fast growth = emerging threat.">Velocity</th>
                        <th ngbTooltip="Matched scam patterns: regex patterns (gray) and semantic matches (yellow)">Patterns</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      @for (threat of data.threats; track threat.id) {
                        <tr>
                          <td>
                            <input type="checkbox" class="form-check-input"
                                   [checked]="isSelected(threat.id)"
                                   (change)="toggleSelect(threat.id)">
                          </td>
                          <td>
                            <strong>{{ threat.query }}</strong>
                            <a [href]="getGoogleSearchUrl(threat.query)"
                               target="_blank"
                               rel="noopener noreferrer"
                               class="ms-2 text-muted"
                               ngbTooltip="Search Google for this query">
                              <i class="bi bi-box-arrow-up-right"></i>
                            </a>
                            @if (threat.isNew) {
                              <span class="badge bg-primary ms-2" ngbTooltip="First appeared in the current period">New</span>
                            }
                          </td>
                          <td>
                            <span class="badge bg-{{ getRiskClass(threat.riskLevel) }}"
                                  ngbTooltip="Score: {{ threat.riskScore }}/100">
                              {{ threat.riskScore }}
                            </span>
                            <small class="d-block text-muted">{{ threat.riskLevel }}</small>
                          </td>
                          <td>
                            <div ngbTooltip="Based on average position {{ threat.current.position.toFixed(1) }}">
                              <small class="text-muted">Expected: {{ (threat.ctrAnomaly.expectedCTR * 100).toFixed(1) }}%</small>
                            </div>
                            <div>
                              <small [class]="threat.ctrAnomaly.isAnomalous ? 'text-danger fw-bold' : ''">
                                Actual: {{ (threat.ctrAnomaly.actualCTR * 100).toFixed(2) }}%
                              </small>
                            </div>
                            @if (threat.ctrAnomaly.isAnomalous) {
                              <span class="badge bg-danger" ngbTooltip="CTR is significantly below expected for this position range">Anomaly</span>
                            }
                          </td>
                          <td>
                            <span>{{ threat.current.position | number:'1.1-1' }}</span>
                          </td>
                          <td>
                            <span ngbTooltip="Current period impressions">{{ threat.current.impressions | number }}</span>
                            @if (threat.change.impressionsPercent > 0) {
                              <small class="text-success d-block" ngbTooltip="Increase from previous period">+{{ threat.change.impressionsPercent.toFixed(0) }}%</small>
                            }
                          </td>
                          <td>
                            <span>{{ threat.current.clicks | number }}</span>
                          </td>
                          <td>
                            @if (threat.velocity) {
                              <div class="d-flex align-items-center gap-1">
                                <span>{{ threat.velocity.impressionsPerDay | number }}</span>
                                @if (threat.velocity.trend === 'accelerating') {
                                  <i class="bi bi-arrow-up-circle-fill text-danger" ngbTooltip="Rapidly accelerating - {{ threat.velocity.impressionsPerDay }}/day"></i>
                                } @else if (threat.velocity.trend === 'steady') {
                                  <i class="bi bi-dash-circle text-warning" ngbTooltip="Steady growth"></i>
                                } @else {
                                  <i class="bi bi-arrow-down-circle text-success" ngbTooltip="Slowing down"></i>
                                }
                              </div>
                            } @else {
                              <span class="text-muted">-</span>
                            }
                          </td>
                          <td>
                            @for (pattern of threat.matchedPatterns; track pattern) {
                              <span class="badge bg-secondary me-1 mb-1" ngbTooltip="Regex pattern match">{{ pattern }}</span>
                            }
                            @for (scam of threat.similarScams; track scam) {
                              <span class="badge bg-warning text-dark me-1 mb-1" ngbTooltip="Semantic similarity to known scam phrase">{{ scam }}</span>
                            }
                          </td>
                          <td>
                            <div class="btn-group btn-group-sm">
                              <button class="btn btn-outline-danger" (click)="addToKeywords(threat)"
                                      ngbTooltip="Add this query to the scam keywords list">
                                <i class="bi bi-plus-circle"></i>
                              </button>
                              <button class="btn btn-outline-secondary" (click)="dismissThreat(threat)"
                                      ngbTooltip="Dismiss this threat for now">
                                <i class="bi bi-x-circle"></i>
                              </button>
                            </div>
                          </td>
                        </tr>
                      }
                    </tbody>
                  </table>
                </div>

                <!-- Pagination -->
                @if (data.pagination.totalPages > 1) {
                  <div class="d-flex justify-content-between align-items-center mt-3">
                    <small class="text-muted">
                      Showing {{ (data.pagination.page - 1) * data.pagination.pageSize + 1 }} -
                      {{ Math.min(data.pagination.page * data.pagination.pageSize, data.pagination.totalItems) }}
                      of {{ data.pagination.totalItems }} threats
                    </small>
                    <ngb-pagination
                      [collectionSize]="data.pagination.totalItems"
                      [page]="data.pagination.page"
                      [pageSize]="data.pagination.pageSize"
                      [maxSize]="5"
                      [rotate]="true"
                      [boundaryLinks]="true"
                      (pageChange)="onPageChange($event)">
                    </ngb-pagination>
                  </div>
                }
              }
            }
          </div>
        </ng-template>
      </li>

      <li [ngbNavItem]="2">
        <button ngbNavLink>Keywords</button>
        <ng-template ngbNavContent>
          <div class="pt-4">
            <!-- Add New Term Form -->
            <div class="card mb-4">
              <div class="card-body">
                <h6 class="card-title">Add New Term</h6>
                <div class="row g-2 align-items-end">
                  <div class="col-md-3">
                    <label class="form-label" for="newTermCategorySelect">Category</label>
                    <select id="newTermCategorySelect" class="form-select" [ngModel]="newTermCategory()" (ngModelChange)="newTermCategory.set($event)">
                      @for (cat of allCategoryKeys; track cat) {
                        <option [value]="cat">{{ getCategoryDisplayName(cat) }}</option>
                      }
                    </select>
                  </div>
                  <div class="col-md-2">
                    <label class="form-label" for="newTermSeveritySelect">Severity</label>
                    <select id="newTermSeveritySelect" class="form-select" [ngModel]="newTermSeverity()" (ngModelChange)="newTermSeverity.set($event)">
                      <option value="critical">Critical</option>
                      <option value="high">High</option>
                      <option value="medium">Medium</option>
                      <option value="low">Low</option>
                    </select>
                  </div>
                  <div class="col-md-3">
                    <label class="form-label" for="newTermInput">Term</label>
                    <input id="newTermInput" type="text" class="form-control" placeholder="Enter term"
                           [ngModel]="newTermText()" (ngModelChange)="newTermText.set($event)"
                           (keyup.enter)="addUnifiedTerm()">
                  </div>
                  <div class="col-md-2">
                    <span class="form-label d-block">Detection</span>
                    <div class="d-flex gap-3">
                      <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="patternMatch"
                               [ngModel]="newTermPatternMatch()" (ngModelChange)="newTermPatternMatch.set($event)">
                        <label class="form-check-label" for="patternMatch" ngbTooltip="Use in Dashboard pattern detection">Pattern</label>
                      </div>
                      <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="embedding"
                               [ngModel]="newTermEmbedding()" (ngModelChange)="newTermEmbedding.set($event)">
                        <label class="form-check-label" for="embedding" ngbTooltip="Use in AI similarity detection">AI</label>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-2">
                    <button class="btn btn-primary w-100" (click)="addUnifiedTerm()" [disabled]="!newTermText().trim()">
                      <i class="bi bi-plus-circle me-1"></i>
                      Add
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Terms Section Header -->
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h6 class="mb-0">Scam Detection Terms</h6>
              <div class="d-flex gap-2 align-items-center">
                <div class="input-group input-group-sm" style="width: 250px;">
                  <span class="input-group-text">
                    <i class="bi bi-search"></i>
                  </span>
                  <input type="text" class="form-control" placeholder="Filter terms..."
                         [ngModel]="termSearchFilter()" (ngModelChange)="termSearchFilter.set($event)">
                  @if (termSearchFilter()) {
                    <button class="btn btn-outline-secondary" type="button" (click)="termSearchFilter.set('')">
                      ✕
                    </button>
                  }
                </div>
                <button class="btn btn-outline-primary btn-sm" (click)="loadUnifiedTerms()" [disabled]="termsLoading()">
                  <i class="bi bi-arrow-clockwise me-1"></i>
                  Refresh
                </button>
              </div>
            </div>
            @if (termSearchFilter()) {
              <div class="mb-3 text-muted small">
                Showing <strong>{{ filteredTermsCount() }}</strong> terms matching "{{ termSearchFilter() }}"
              </div>
            }

            <!-- Loading -->
            @if (termsLoading()) {
              <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
              </div>
            } @else if (unifiedTermsResponse(); as response) {
              <!-- Terms by Category -->
              @for (cat of allCategoryKeys; track cat) {
                <div class="card mb-3">
                  <div class="card-header d-flex justify-content-between align-items-center">
                    <span>
                      <strong>{{ getCategoryDisplayName(cat) }}</strong>
                      <span class="badge bg-secondary ms-2">{{ termsByCategory().get(cat)?.length || 0 }}</span>
                    </span>
                    <span class="badge bg-{{ getRiskClass(getCategorySeverity(cat)) }}">
                      {{ getCategorySeverity(cat) }}
                    </span>
                  </div>
                  <div class="card-body">
                    @if (!termsByCategory().get(cat) || termsByCategory().get(cat)!.length === 0) {
                      <span class="text-muted">No terms in this category</span>
                    } @else {
                      @for (term of termsByCategory().get(cat); track term.term) {
                        <span class="badge me-1 mb-1 p-2 d-inline-flex align-items-center gap-2 bg-light text-dark border">
                          {{ term.term }}
                          @if (term.useForPatternMatch && term.useForEmbedding) {
                            <span class="badge bg-success" ngbTooltip="Pattern Match + AI">P+AI</span>
                          } @else if (term.useForPatternMatch) {
                            <span class="badge bg-primary" ngbTooltip="Pattern Match only">P</span>
                          } @else if (term.useForEmbedding) {
                            <span class="badge bg-warning text-dark" ngbTooltip="AI Embedding only">AI</span>
                          }
                          @if (term.source === 'admin') {
                            <span class="badge bg-secondary" ngbTooltip="Added via admin UI">Admin</span>
                          }
                          <button class="btn btn-outline-danger btn-sm py-0 px-1" (click)="removeUnifiedTerm(term)"
                                  title="Remove this term">
                            ✕
                          </button>
                        </span>
                      }
                    }
                  </div>
                </div>
              }

              <!-- Removed Terms Section -->
              @if (response.removedTerms.length > 0) {
                <div class="card mt-4">
                  <button type="button"
                          class="card-header d-flex justify-content-between align-items-center w-100 border-0 text-start"
                          style="cursor: pointer; background: inherit;"
                          (click)="showRemovedTerms.set(!showRemovedTerms())">
                    <span>
                      <i class="bi" [ngClass]="showRemovedTerms() ? 'bi-chevron-down' : 'bi-chevron-right'"></i>
                      <strong class="ms-2">Removed Terms</strong>
                      <span class="badge bg-secondary ms-2">{{ response.removedTerms.length }}</span>
                    </span>
                    <small class="text-muted">Click to {{ showRemovedTerms() ? 'collapse' : 'expand' }}</small>
                  </button>
                  @if (showRemovedTerms()) {
                    <div class="card-body">
                      <p class="text-muted small">These JSON-seeded terms have been removed. Click Restore to re-enable them.</p>
                      @for (term of response.removedTerms; track term.term + term.category) {
                        <span class="badge bg-light text-dark me-1 mb-1 p-2 d-inline-flex align-items-center gap-2">
                          <span class="text-decoration-line-through">{{ term.term }}</span>
                          <small class="text-muted">({{ getCategoryDisplayName(term.category) }})</small>
                          <button class="btn btn-link btn-sm p-0 text-success" (click)="restoreUnifiedTerm(term)"
                                  ngbTooltip="Restore this term">
                            <i class="bi bi-arrow-counterclockwise"></i>
                            Restore
                          </button>
                        </span>
                      }
                    </div>
                  }
                </div>
              }
            } @else {
              <!-- No terms loaded -->
              <div class="alert alert-warning">
                <strong>No terms loaded.</strong> Click "Refresh" to load from DynamoDB.
              </div>
            }
          </div>
        </ng-template>
      </li>

    </ul>

    <div [ngbNavOutlet]="nav"></div>
  }
</div>

<!-- Category Selection Modal -->
<ng-template #categoryModal let-modal>
  <div class="modal-header">
    <h5 class="modal-title">Add to Keywords</h5>
    <button type="button" class="btn-close" aria-label="Close" (click)="modal.dismiss()"></button>
  </div>
  <div class="modal-body">
    @if (bulkModalAction() === 'keyword') {
      <p>Add <strong>{{ getSelectedCount() }} selected item(s)</strong> to which category?</p>
    } @else if (pendingThreat(); as threat) {
      <p>Add "<strong>{{ threat.query }}</strong>" to which category?</p>
    }
    <div class="list-group">
      <button type="button" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
              [class.active]="modalCategory() === 'fakeExpiredBenefits'"
              (click)="modalCategory.set('fakeExpiredBenefits')">
        Fake/Expired Benefits
        <span class="badge bg-danger">Critical</span>
      </button>
      <button type="button" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
              [class.active]="modalCategory() === 'illegitimatePaymentMethods'"
              (click)="modalCategory.set('illegitimatePaymentMethods')">
        Illegitimate Payment Methods
        <span class="badge bg-danger">Critical</span>
      </button>
      <button type="button" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
              [class.active]="modalCategory() === 'threatLanguage'"
              (click)="modalCategory.set('threatLanguage')">
        Threat Language
        <span class="badge bg-warning text-dark">High</span>
      </button>
      <button type="button" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
              [class.active]="modalCategory() === 'suspiciousModifiers'"
              (click)="modalCategory.set('suspiciousModifiers')">
        Suspicious Modifiers
        <span class="badge bg-info">Medium</span>
      </button>
      <button type="button" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
              [class.active]="modalCategory() === 'scamPatterns'"
              (click)="modalCategory.set('scamPatterns')">
        Scam Patterns
        <span class="badge bg-warning text-dark">High</span>
      </button>
    </div>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-secondary" (click)="modal.dismiss()">Cancel</button>
    <button type="button" class="btn btn-primary" (click)="confirmAddKeyword()">
      @if (bulkModalAction() === 'keyword') {
        Add {{ getSelectedCount() }} Keywords
      } @else {
        Add Keyword
      }
    </button>
  </div>
</ng-template>
